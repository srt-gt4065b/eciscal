<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ECIS Academic Calendar</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#264653">
    <meta name="apple-mobile-web-app-title" content="ECIS Cal">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-cream: #FAF9F6; --deep-teal: #264653; --text-dark: #2c3e50;
            --card-shadow: 5px 5px 0px rgba(38, 70, 83, 0.15);
            /* Department Colors */
            --col-common: #8BC34A; --col-aim: #9B59B6; --col-aib: #3498DB;
            --col-gh: #F1C40F; --col-id: #E67E22;
            --col-holiday: #E74C3C; --col-academic: #2A9D8F;
        }

        body {
            font-family: 'Open Sans', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-cream); color: var(--text-dark);
            margin: 0; padding: 0;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
            background-image: radial-gradient(circle at 10% 20%, rgba(231, 111, 81, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(42, 157, 143, 0.05) 0%, transparent 20%);
            background-attachment: fixed; -webkit-tap-highlight-color: transparent;
        }

        header {
            background-color: var(--deep-teal); color: white;
            padding: 60px 20px 40px; text-align: center; position: relative;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }

        .lang-switcher {
            position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 50;
        }
        .lang-btn {
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            color: white; padding: 6px 10px; border-radius: 15px;
            cursor: pointer; font-weight: bold; font-family: 'Montserrat'; font-size: 0.75em;
        }
        .lang-btn.active { background: var(--col-gh); color: #333; border-color: var(--col-gh); }

        h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.8em; margin: 0; text-transform: uppercase; line-height: 1.2; }
        p { margin-top: 15px; font-size: 1em; opacity: 0.9; }

        .container { max-width: 800px; margin: -30px auto 100px; padding: 0 15px; position: relative; z-index: 10; }

        .controls { text-align: center; margin-bottom: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        select { padding: 10px 20px; border-radius: 30px; border: 3px solid var(--deep-teal); font-size: 16px; font-weight: 700; color: var(--deep-teal); background: white; }

        /* Install Button Styles */
        #installBtn {
            display: none; /* JS will toggle this */
            padding: 10px 20px; border-radius: 30px;
            background: var(--col-id); color: white; border: none;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 20px; align-items: start; }
        @media(min-width: 600px) { .calendar-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }

        .event-card {
            background: white; border: 2px solid var(--deep-teal);
            padding: 20px; position: relative; border-radius: 15px;
            box-shadow: var(--card-shadow); transition: transform 0.2s;
        }
        .event-card:active { transform: scale(0.98); }
        .event-card.dept-common { border-left: 8px solid var(--col-common); }
        .event-card.dept-aim { border-left: 8px solid var(--col-aim); }
        .event-card.dept-aib { border-left: 8px solid var(--col-aib); }
        .event-card.dept-gh { border-left: 8px solid var(--col-gh); }
        .event-card.dept-id { border-left: 8px solid var(--col-id); }
        .event-card.holiday { border-left: 8px solid var(--col-holiday); }
        .event-card.academic { border-left: 8px solid var(--col-academic); }
        .event-card.event { border-left: 8px solid var(--deep-teal); }

        .user-badge { position: absolute; top: 15px; right: 15px; background: #333; color: white; font-size: 0.7em; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
        .event-month { font-weight: 900; color: #aaa; font-size: 0.8em; margin-bottom: 5px; }
        .event-date { font-family: 'Montserrat'; font-size: 1.4em; font-weight: 900; margin-bottom: 10px; color: var(--deep-teal); }
        .tag { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.7em; font-weight: 700; color: white; margin-top: 10px; }
        .tag.dept-common { background: var(--col-common); } .tag.dept-aim { background: var(--col-aim); }
        .tag.dept-aib { background: var(--col-aib); } .tag.dept-gh { background: var(--col-gh); color: #333; }
        .tag.dept-id { background: var(--col-id); } .tag.holiday { background: var(--col-holiday); }
        .tag.academic { background: var(--col-academic); } .tag.event { background: var(--deep-teal); }

        .fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background-color: var(--deep-teal); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; border: 2px solid white; cursor: pointer; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; backdrop-filter: blur(3px); align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 30px 20px; width: 85%; max-width: 400px; border-radius: 20px; border: 3px solid var(--deep-teal); }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; }
        .btn-save { background: var(--deep-teal); color: white; } .btn-cancel { background: #eee; }
    </style>
</head>
<body>

<script>
    // PWA ì•„ì´ì½˜ ë° ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìë™ ìƒì„± (ê±´ë“œë¦´ í•„ìš” ì—†ìŒ)
    const iconCanvas = document.createElement('canvas'); iconCanvas.width = 512; iconCanvas.height = 512;
    const ctx = iconCanvas.getContext('2d'); ctx.fillStyle = '#264653'; ctx.fillRect(0,0,512,512);
    ctx.font = '300px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ğŸ¨', 256, 270);
    const iconUrl = iconCanvas.toDataURL('image/png');
    const linkIcon = document.createElement('link'); linkIcon.rel = 'apple-touch-icon'; linkIcon.href = iconUrl; document.head.appendChild(linkIcon);
    const linkFav = document.createElement('link'); linkFav.rel = 'icon'; linkFav.href = iconUrl; document.head.appendChild(linkFav);
    
    // [ì¤‘ìš”] GitHub Pages í˜¸í™˜ì„±ì„ ìœ„í•´ start_urlì— "./index.html" ëª…ì‹œ
    const manifest = {
        "name": "ECIS Calendar", "short_name": "ECIS Cal", "start_url": "./index.html", "display": "standalone",
        "background_color": "#FAF9F6", "theme_color": "#264653", "orientation": "portrait",
        "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/png" }]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const linkManifest = document.createElement('link'); linkManifest.rel = 'manifest'; linkManifest.href = URL.createObjectURL(blob); document.head.appendChild(linkManifest);
</script>

<script>
  if ('serviceWorker' in navigator) {
    // [ì¤‘ìš”] sw.js íŒŒì¼ì€ index.htmlê³¼ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•¨
    navigator.serviceWorker.register('./sw.js')
      .then((reg) => { console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', reg); })
      .catch((err) => { console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', err); });
  }
</script>

<header>
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="setLanguage('ko')">KO</button>
        <button class="lang-btn" onclick="setLanguage('en')">EN</button>
        <button class="lang-btn" onclick="setLanguage('zh')">ZH</button>
    </div>
    <h1 id="ui-title">2026 ECIS Academic Calendar</h1>
    <p id="ui-subtitle">Woosong University</p>
</header>

<div class="container">
    <div class="controls">
        <button id="installBtn" onclick="handleInstall()">ğŸ“² Install App</button>
        <select id="monthFilter" onchange="renderCalendar()"></select>
    </div>

    <div id="calendarGrid" class="calendar-grid">
        <p style="text-align:center;">Loading...</p>
    </div>
</div>

<div class="fab" onclick="openModal()">+</div>

<div class="modal-overlay" id="eventModal">
    <div class="modal-content">
        <h2 id="modal-title">âœï¸ Add Event</h2>
        <div class="form-group">
            <label id="label-title">Title</label> <input type="text" id="inputTitle">
        </div>
        <div class="form-group">
            <label id="label-start">Start Date</label> <input type="date" id="inputStart">
        </div>
        <div class="form-group">
            <label id="label-end">End Date</label> <input type="date" id="inputEnd">
        </div>
        <div class="form-group">
            <label id="label-cat">Dept / Category</label>
            <select id="inputType">
                <option value="dept-common">ğŸŸ¢ Common</option> <option value="dept-aim">ğŸŸ£ AI Mgmt</option>
                <option value="dept-aib">ğŸ”µ AI BigData</option> <option value="dept-gh">ğŸŸ¡ Global Hosp</option>
                <option value="dept-id">ğŸŸ  Interdisciplinary</option>
            </select>
        </div>
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal()" id="btn-cancel">Cancel</button>
            <button class="btn btn-save" onclick="saveEvent()" id="btn-save">Save</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // ğŸ”´ [YOUR FIREBASE CONFIG HERE]
    const firebaseConfig = {
      apiKey: "AIzaSyAdkdWL2ab0f_fiYvmS0Q_btAQP76-IufM",
      authDomain: "ecis-calendar-c83bb.firebaseapp.com",
      databaseURL: "https://ecis-calendar-c83bb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ecis-calendar-c83bb",
      storageBucket: "ecis-calendar-c83bb.firebasestorage.app",
      messagingSenderId: "412332086060",
      appId: "1:412332086060:web:fc3c0aeec7d298ffb5d289",
      measurementId: "G-VEZ16FP32S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentLang = 'ko';
    // PWA ì„¤ì¹˜ ì´ë²¤íŠ¸ ì €ì¥ ë³€ìˆ˜
    let deferredPrompt; 

    const i18n = {
        ko: {
            title: "2026 ECIS í•™ì‚¬ ì¼ì •", subtitle: "ìš°ì†¡ëŒ€í•™êµ Endicott College",
            allMonths: "ì „ì²´ ë³´ê¸°", empty: "ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.",
            modalTitle: "ì¼ì • ì¶”ê°€", lblTitle: "ì œëª©", lblStart: "ì‹œì‘ì¼", lblEnd: "ì¢…ë£Œì¼", lblCat: "êµ¬ë¶„",
            btnCancel: "ì·¨ì†Œ", btnSave: "ì €ì¥", install: "ğŸ“² ì•± ì„¤ì¹˜í•˜ê¸°", install_ios: "ğŸ“² ì•„ì´í° ì„¤ì¹˜ ê°€ì´ë“œ",
            cats: { "dept-common":"ğŸŸ¢ ê³µí†µ", "dept-aim":"ğŸŸ£ AIê²½ì˜", "dept-aib":"ğŸ”µ AIë¹…ë°ì´í„°", "dept-gh":"ğŸŸ¡ ê¸€ë¡œë²Œí˜¸ìŠ¤í”¼", "dept-id":"ğŸŸ  ììœ ì „ê³µ", holiday:"ğŸ”´ ê³µíœ´ì¼", academic:"ğŸ”µ í•™ì‚¬", event:"ğŸŸ¡ í–‰ì‚¬" },
            months: ["1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”","7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"]
        },
        en: {
            title: "2026 ECIS Calendar", subtitle: "Woosong Univ. Endicott College",
            allMonths: "View All", empty: "No events.",
            modalTitle: "Add Event", lblTitle: "Title", lblStart: "Start", lblEnd: "End", lblCat: "Dept",
            btnCancel: "Cancel", btnSave: "Save", install: "ğŸ“² Install App", install_ios: "ğŸ“² Install Guide (iOS)",
            cats: { "dept-common":"ğŸŸ¢ Common", "dept-aim":"ğŸŸ£ AI Mgmt", "dept-aib":"ğŸ”µ AI BigData", "dept-gh":"ğŸŸ¡ Global Hosp", "dept-id":"ğŸŸ  Interdisciplinary", holiday:"ğŸ”´ Holiday", academic:"ğŸ”µ Academic", event:"ğŸŸ¡ Event" },
            months: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
        },
        zh: {
            title: "2026 ECIS æ ¡å†", subtitle: "åˆæ¾å¤§å­¦ Endicott å­¦é™¢",
            allMonths: "æŸ¥çœ‹å…¨éƒ¨", empty: "æ— æ—¥ç¨‹",
            modalTitle: "æ·»åŠ æ—¥ç¨‹", lblTitle: "æ ‡é¢˜", lblStart: "å¼€å§‹", lblEnd: "ç»“æŸ", lblCat: "åˆ†ç±»",
            btnCancel: "å–æ¶ˆ", btnSave: "ä¿å­˜", install: "ğŸ“² å®‰è£…åº”ç”¨", install_ios: "ğŸ“² å®‰è£…æŒ‡å— (iOS)",
            cats: { "dept-common":"ğŸŸ¢ å…¬å…±", "dept-aim":"ğŸŸ£ AIç»è¥", "dept-aib":"ğŸ”µ AIå¤§æ•°æ®", "dept-gh":"ğŸŸ¡ å…¨çƒé…’åº—", "dept-id":"ğŸŸ  è‡ªç”±ä¸“ä¸š", holiday:"ğŸ”´ å…¬ä¼‘", academic:"ğŸ”µ å­¦äº‹", event:"ğŸŸ¡ æ´»åŠ¨" },
            months: ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"]
        }
    };

    const staticEvents = [
        { month: 1, date: "2026-01-01", type: "holiday", title: { ko: "ìƒˆí•´", en: "New Year", zh: "å…ƒæ—¦" } },
        { month: 2, date: "2026-02-27", type: "event", title: { ko: "ì…í•™ì‹", en: "Matriculation", zh: "å…¥å­¦å…¸ç¤¼" } },
        { month: 3, date: "2026-03-02", type: "academic", title: { ko: "ê°œê°•", en: "Spring Begins", zh: "å¼€å­¦" } }
    ];

    let allEvents = [];
    const eventsRef = ref(db, 'events');
    onValue(eventsRef, (snap) => {
        const data = snap.val();
        const userEvents = data ? Object.values(data) : [];
        allEvents = [...staticEvents, ...userEvents].sort((a,b)=>a.date.localeCompare(b.date));
        renderUI(); // ë°ì´í„° ì˜¤ë©´ í™”ë©´ ê°±ì‹ 
    });

    window.setLanguage = (lang) => {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');
        renderUI();
    };

    window.renderUI = () => {
        const t = i18n[currentLang];
        document.getElementById('ui-title').innerText = t.title;
        document.getElementById('ui-subtitle').innerText = t.subtitle;
        
        // PWA ë²„íŠ¼ í…ìŠ¤íŠ¸
        const installBtn = document.getElementById('installBtn');
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        if(isIOS) installBtn.innerText = t.install_ios;
        else installBtn.innerText = t.install;

        document.getElementById('modal-title').innerText = t.modalTitle;
        document.getElementById('label-title').innerText = t.lblTitle;
        document.getElementById('label-start').innerText = t.lblStart;
        document.getElementById('label-end').innerText = t.lblEnd;
        document.getElementById('label-cat').innerText = t.lblCat;
        document.getElementById('btn-cancel').innerText = t.btnCancel;
        document.getElementById('btn-save').innerText = t.btnSave;
        
        // ëª¨ë‹¬ì°½ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const opts = document.getElementById('inputType').options;
        for(let i=0; i<opts.length; i++) {
             if(t.cats[opts[i].value]) opts[i].innerText = t.cats[opts[i].value];
        }

        // ì›” í•„í„° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì„ íƒê°’ ìœ ì§€)
        const monthSelect = document.getElementById('monthFilter');
        const currentVal = monthSelect.value;
        monthSelect.innerHTML = `<option value="all">${t.allMonths}</option>`;
        t.months.forEach((m, idx) => {
            monthSelect.innerHTML += `<option value="${idx+1}">${m}</option>`;
        });
        if(currentVal) monthSelect.value = currentVal;

        renderCalendar(); // ì‹¤ì œ ì¹´ë“œ ê·¸ë¦¬ê¸° í˜¸ì¶œ
    };

    window.renderCalendar = () => {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        
        const filterVal = document.getElementById('monthFilter').value;
        const t = i18n[currentLang];

        // í•„í„°ë§
        const filtered = allEvents.filter(e => {
            if(filterVal === 'all') return true;
            // e.monthê°€ ìˆ«ìí˜•ì¸ì§€ í™•ì¸ í•„ìš” (ì‚¬ìš©ìê°€ ë„£ì€ê±´ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ)
            const m = parseInt(e.date.split('-')[1]); 
            return m === parseInt(filterVal);
        });

        if(filtered.length === 0) {
            grid.innerHTML = `<p style="text-align:center; width:100%; margin-top:50px; color:#aaa;">${t.empty}</p>`;
            return;
        }

        filtered.forEach(e => {
            const card = document.createElement('div');
            card.className = `event-card ${e.type}`;
            
            // ì œëª© ì²˜ë¦¬ (ë‹¤êµ­ì–´ ê°ì²´ë©´ í˜„ì¬ ì–¸ì–´, ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ)
            const titleText = (typeof e.title === 'object') ? (e.title[currentLang] || e.title.ko) : e.title;
            
            // ë‚ ì§œ í¬ë§·íŒ…
            const d = new Date(e.date);
            const dateStr = `${d.getMonth()+1}.${d.getDate()}`;
            const monthName = t.months[d.getMonth()];

            // ì¹´í…Œê³ ë¦¬ ì´ë¦„
            const catName = t.cats[e.type] || e.type;

            card.innerHTML = `
                ${e.isUser ? '<span class="user-badge">User</span>' : ''}
                <div class="event-month">${monthName}</div>
                <div class="event-date">${dateStr}</div>
                <div style="font-weight:bold; font-size:1.1em; word-break:keep-all;">${titleText}</div>
                <span class="tag ${e.type}">${catName}</span>
            `;
            grid.appendChild(card);
        });
    };

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    window.openModal = () => { document.getElementById('eventModal').style.display = 'flex'; };
    window.closeModal = () => { document.getElementById('eventModal').style.display = 'none'; };

    window.saveEvent = () => {
        const title = document.getElementById('inputTitle').value;
        const start = document.getElementById('inputStart').value;
        const type = document.getElementById('inputType').value;

        if(!title || !start) { alert("Title and Date required!"); return; }

        push(ref(db, 'events'), {
            title: title,
            date: start,
            type: type,
            isUser: true,
            createdAt: Date.now()
        }).then(() => {
            closeModal();
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('inputTitle').value = "";
            document.getElementById('inputStart').value = "";
        }).catch(err => alert("Error: " + err.message));
    };

    // PWA ì„¤ì¹˜ ë¡œì§
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installBtn');
        if(btn) btn.style.display = 'inline-block';
    });

    window.handleInstall = () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted install');
            }
            deferredPrompt = null;
        });
    };
</script>
</body>
</html>
